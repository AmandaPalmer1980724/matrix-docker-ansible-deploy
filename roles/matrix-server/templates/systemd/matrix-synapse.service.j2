[Unit]
Description=Matrix Synapse server
After=docker.service
Requires=docker.service
Requires=matrix-postgres.service
After=matrix-postgres.service

[Service]
Type=simple
ExecStartPre=-/usr/bin/docker kill matrix-synapse
ExecStartPre=-/usr/bin/docker rm matrix-synapse
ExecStartPre=-/usr/bin/chown {{ matrix_user_username }}:{{ matrix_user_username }} {{ ssl_certs_path }} -R
ExecStart=/usr/bin/docker run --rm --name matrix-synapse \
			--link matrix-postgres:postgres \
			-p 8448:8448 \
			-p 3478:3478 \
			-p 3478:3478/udp \
			-p {{ matrix_coturn_turn_udp_min_port }}-{{ matrix_coturn_turn_udp_max_port }}:{{ matrix_coturn_turn_udp_min_port }}-{{ matrix_coturn_turn_udp_max_port }}/udp \
			-v {{ matrix_synapse_config_dir_path }}:/data \
			-v {{ matrix_synapse_run_path }}:/matrix-run \
			-v {{ matrix_synapse_media_store_path }}:/matrix-media-store \
			-v {{ ssl_certs_path }}:/acmetool-certs \
			{{ docker_matrix_image }}
ExecStop=-/usr/bin/docker kill matrix-synapse
ExecStop=-/usr/bin/docker rm matrix-synapse
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
